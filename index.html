<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fulus - –û–±–º–µ–Ω –≤–∞–ª—é—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --sand-light:#F5E6D3; --sand:#D4A574; --sand-dark:#B8956C; --blue-deep:#1A365D; --blue-royal:#234E82; --blue-accent:#3B82A0; --blue-light:#5BA4C4; --gold:#C9A227; --gold-light:#E8D48B; --text-light:#F7FAFC; --bg-gradient:linear-gradient(165deg,#1A365D 0%,#234E82 40%,#2D5A7B 70%,#3B82A0 100%); --card-bg:rgba(255,255,255,0.08); --card-border:rgba(212,165,116,0.3); }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Montserrat',sans-serif; background:var(--bg-gradient); min-height:100vh; color:var(--text-light); }
        .container { position:relative; z-index:1; max-width:100%; padding:0 16px 90px; }
        .header { text-align:center; padding:20px 0 12px; }
        .logo { font-family:'Amiri',serif; font-size:38px; font-weight:700; color:var(--sand); letter-spacing:4px; }
        .logo-arabic { font-family:'Amiri',serif; font-size:20px; color:var(--gold-light); opacity:0.9; direction:rtl; }
        .subtitle { font-size:10px; text-transform:uppercase; letter-spacing:3px; color:var(--blue-light); margin-top:6px; }
        .decorative-line { display:flex; align-items:center; justify-content:center; gap:12px; margin:10px 0 16px; }
        .decorative-line::before,.decorative-line::after { content:''; width:50px; height:1px; background:linear-gradient(90deg,transparent,var(--sand),transparent); }
        .decorative-diamond { width:6px; height:6px; background:var(--gold); transform:rotate(45deg); }
        .section-title { font-family:'Amiri',serif; font-size:18px; color:var(--sand); margin-bottom:12px; display:flex; align-items:center; gap:10px; }
        .section-title::after { content:''; flex:1; height:1px; background:linear-gradient(90deg,var(--sand-dark),transparent); }
        .city-emoji { font-size:32px; margin-bottom:6px; }
        .city-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:12px; }
        .city-grid-5 { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:16px; }
        .city-card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:12px 8px; text-align:center; cursor:pointer; transition:all 0.3s; position:relative; overflow:hidden; }
        .city-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg,var(--sand),var(--gold),var(--sand)); opacity:0; transition:opacity 0.3s; }
        .city-card:hover,.city-card.active { background:rgba(212,165,116,0.15); border-color:var(--sand); transform:translateY(-2px); }
        .city-card.active::before { opacity:1; }
        .city-card-small { padding:10px 4px; }
        .city-card-small .city-emoji { font-size:24px; margin-bottom:4px; }
        .city-card-small .city-name { font-size:10px; }
        .city-card-small .city-currency { font-size:8px; }
        .city-name { font-weight:600; font-size:13px; margin-bottom:2px; }
        .city-currency { font-size:10px; color:var(--sand-light); opacity:0.7; display:flex; align-items:center; justify-content:center; gap:4px; }
        .russia-cities { display:none; margin-bottom:12px; }
        .russia-cities.visible { display:block; animation:fadeIn 0.4s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .rates-container { display:none; margin-bottom:16px; }
        .rates-container.visible { display:block; animation:fadeIn 0.4s; }
        .rate-card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:14px; margin-bottom:8px; }
        .rate-pair { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:10px; }
        .currency-badge { background:linear-gradient(135deg,var(--blue-royal),var(--blue-accent)); padding:5px 10px; border-radius:8px; font-weight:600; font-size:12px; display:flex; align-items:center; gap:4px; }
        .rate-arrow { color:var(--gold); font-size:16px; }
        .rate-values { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
        .rate-item { text-align:center; padding:8px; background:rgba(0,0,0,0.2); border-radius:8px; }
        .rate-label { font-size:9px; text-transform:uppercase; letter-spacing:1px; color:var(--sand-light); opacity:0.7; margin-bottom:3px; }
        .rate-value { font-size:18px; font-weight:700; color:var(--sand); }
        .section { display:none; }
        .section.visible { display:block; animation:fadeIn 0.4s; }
        .tabs { display:flex; background:var(--card-bg); border-radius:12px; padding:4px; margin-bottom:14px; border:1px solid var(--card-border); }
        .tab { flex:1; padding:10px; text-align:center; border-radius:8px; cursor:pointer; font-weight:600; font-size:12px; color:var(--text-light); opacity:0.6; transition:all 0.3s; }
        .tab.active { background:linear-gradient(135deg,var(--sand-dark),var(--gold)); color:var(--blue-deep); opacity:1; }
        .form-card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:16px; margin-bottom:12px; }
        .input-group { margin-bottom:12px; }
        .input-group label { display:block; font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--sand-light); margin-bottom:5px; }
        .input-group input,.input-group select,.input-group textarea { width:100%; padding:10px 12px; background:rgba(0,0,0,0.3); border:1px solid var(--card-border); border-radius:8px; color:var(--text-light); font-size:13px; font-family:'Montserrat',sans-serif; }
        .input-group textarea { min-height:100px; resize:vertical; }
        .input-group input:focus,.input-group select:focus,.input-group textarea:focus { outline:none; border-color:var(--sand); }
        .input-group input::placeholder,.input-group textarea::placeholder { color:rgba(255,255,255,0.3); }
        .input-group select { cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' stroke='%23D4A574' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 10px center; background-size:14px; }
        .amount-display { background:linear-gradient(135deg,rgba(26,54,93,0.8),rgba(35,78,130,0.8)); border:1px solid var(--gold); border-radius:12px; padding:12px; margin:14px 0; text-align:center; }
        .amount-display-label { font-size:9px; text-transform:uppercase; letter-spacing:1px; color:var(--sand-light); margin-bottom:3px; }
        .amount-display-value { font-size:22px; font-weight:700; color:var(--gold-light); }
        .submit-btn { width:100%; padding:14px; background:linear-gradient(135deg,var(--sand-dark),var(--gold)); border:none; border-radius:10px; color:var(--blue-deep); font-size:14px; font-weight:700; font-family:'Montserrat',sans-serif; cursor:pointer; text-transform:uppercase; letter-spacing:2px; }
        .submit-btn.small { padding:10px; font-size:12px; text-transform:none; letter-spacing:0; }
        .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:linear-gradient(to top,var(--blue-deep),rgba(26,54,93,0.98)); padding:8px 12px 14px; display:flex; justify-content:space-around; border-top:1px solid var(--card-border); z-index:100; }
        .nav-item { display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; opacity:0.6; transition:all 0.3s; padding:4px 8px; }
        .nav-item.active { opacity:1; }
        .nav-item.active .nav-icon { color:var(--gold); }
        .nav-item.active .nav-label { color:var(--sand); }
        .nav-icon { font-size:18px; }
        .nav-label { font-size:8px; text-transform:uppercase; letter-spacing:1px; }
        .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:200; padding:20px; }
        .modal-overlay.visible { display:flex; animation:fadeIn 0.3s; }
        .modal { background:linear-gradient(165deg,var(--blue-deep),var(--blue-royal)); border:1px solid var(--sand); border-radius:16px; padding:24px 18px; text-align:center; max-width:280px; width:100%; }
        .modal-icon { font-size:48px; margin-bottom:12px; }
        .modal-title { font-family:'Amiri',serif; font-size:20px; color:var(--sand); margin-bottom:8px; }
        .modal-text { font-size:12px; color:var(--sand-light); opacity:0.8; margin-bottom:16px; }
        .modal-btn { padding:10px 24px; background:linear-gradient(135deg,var(--sand-dark),var(--gold)); border:none; border-radius:8px; color:var(--blue-deep); font-size:12px; font-weight:600; cursor:pointer; }
        .order-card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px; padding:12px 14px; margin-bottom:8px; }
        .order-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .order-id { font-weight:600; color:var(--sand); font-size:13px; }
        .order-status { font-size:10px; padding:3px 8px; border-radius:12px; font-weight:500; }
        .order-status.pending { background:rgba(255,193,7,0.2); color:#FFC107; }
        .order-status.completed { background:rgba(76,175,80,0.2); color:#4CAF50; }
        .order-status.cancelled { background:rgba(244,67,54,0.2); color:#F44336; }
        .order-details { font-size:11px; color:var(--sand-light); }
        .order-details div { margin-bottom:3px; }
        .order-amount { font-size:13px; font-weight:600; color:var(--gold-light); margin-top:6px; }
        .empty-state { text-align:center; padding:30px 20px; color:var(--sand-light); }
        .empty-state-icon { font-size:40px; margin-bottom:12px; opacity:0.5; }
        .empty-state-text { font-size:13px; margin-bottom:16px; }
        .about-card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:16px; margin-bottom:12px; }
        .about-title { font-family:'Amiri',serif; font-size:16px; color:var(--sand); margin-bottom:12px; }
        .about-item { display:flex; align-items:flex-start; gap:8px; margin-bottom:10px; }
        .about-text { font-size:12px; line-height:1.4; color:var(--sand-light); }
        .contact-btn { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:12px; background:var(--card-bg); border:1px solid var(--card-border); border-radius:10px; color:var(--text-light); font-size:12px; font-weight:500; cursor:pointer; text-decoration:none; }
        .admin-card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px; padding:14px; margin-bottom:10px; }
        .admin-card-title { font-size:14px; font-weight:600; color:var(--sand); margin-bottom:10px; }
        .admin-row { display:flex; gap:8px; margin-bottom:8px; }
        .admin-row input { flex:1; }
        .admin-tabs { display:flex; gap:6px; margin-bottom:14px; flex-wrap:wrap; }
        .admin-tab { padding:8px 12px; background:var(--card-bg); border:1px solid var(--card-border); border-radius:8px; font-size:11px; cursor:pointer; }
        .admin-tab.active { background:linear-gradient(135deg,var(--sand-dark),var(--gold)); color:var(--blue-deep); border-color:var(--gold); }
        .rate-edit-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; margin-bottom:8px; align-items:center; }
        .rate-edit-row span { font-size:11px; color:var(--sand-light); }
        .rate-edit-row input { padding:8px; font-size:12px; }
        .order-actions { display:flex; gap:6px; margin-top:8px; }
        .order-action-btn { padding:6px 12px; font-size:10px; border-radius:6px; cursor:pointer; border:none; font-family:'Montserrat',sans-serif; }
        .order-action-btn.complete { background:rgba(76,175,80,0.3); color:#4CAF50; }
        .order-action-btn.cancel { background:rgba(244,67,54,0.3); color:#F44336; }
        .save-indicator { font-size:11px; color:#4CAF50; margin-left:8px; opacity:0; transition:opacity 0.3s; }
        .save-indicator.visible { opacity:1; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">FULUS</div>
            <div class="logo-arabic">ŸÅŸèŸÑŸèŸàÿ≥</div>
            <div class="subtitle">–û–±–º–µ–Ω –≤–∞–ª—é—Ç</div>
        </header>
        <div class="decorative-line"><div class="decorative-diamond"></div></div>

        <div id="mainSection" class="section">
            <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</div>
            <div class="city-grid" id="mainCityGrid"></div>
            <div id="russiaCities" class="russia-cities"><div class="city-grid-5" id="russiaCitiesGrid"></div></div>
            <div id="ratesSection" class="rates-container">
                <div class="section-title">–ö—É—Ä—Å—ã –æ–±–º–µ–Ω–∞</div>
                <div id="ratesContent"></div>
            </div>
        </div>

        <div id="exchangeSection" class="section visible">
            <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</div>
            <div class="city-grid" id="exchangeCityGrid"></div>
            <div id="exchangeRussiaCities" class="russia-cities"><div class="city-grid-5" id="exchangeRussiaCitiesGrid"></div></div>
            <div class="city-card" onclick="selectExchangeCity('other')" style="margin-bottom:16px">
                <div class="city-emoji">üìç</div>
                <div class="city-name">–í–∞—à –≥–æ—Ä–æ–¥</div>
                <div class="city-currency"><span>üåç</span> –î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥</div>
            </div>
            <div id="exchangeFormContainer" style="display:none">
                <div class="section-title">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</div>
                <div class="tabs">
                    <div class="tab active" data-type="buy" onclick="setExchangeType('buy')">–ö—É–ø–∏—Ç—å</div>
                    <div class="tab" data-type="sell" onclick="setExchangeType('sell')">–ü—Ä–æ–¥–∞—Ç—å</div>
                </div>
                <div class="form-card">
                    <div class="input-group"><label>–ì–æ—Ä–æ–¥</label><input type="text" id="cityInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"></div>
                    <div class="input-group"><label>–í–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞</label><select id="pairSelect" onchange="updateCalculation()"></select></div>
                    <div class="input-group"><label id="amountLabel">–°—É–º–º–∞</label><input type="number" id="amountInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" oninput="updateCalculation()" inputmode="decimal"></div>
                    <div class="amount-display"><div class="amount-display-label">–í—ã –ø–æ–ª—É—á–∏—Ç–µ</div><div class="amount-display-value" id="resultAmount">0.00</div></div>
                    <div class="input-group"><label>–í–∞—à–µ –∏–º—è</label><input type="text" id="nameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"></div>
                    <div class="input-group"><label>WhatsApp / –¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input type="tel" id="contactInput" placeholder="+7 999 123 45 67"></div>
                    <button class="submit-btn" onclick="submitOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                </div>
            </div>
        </div>

        <div id="ordersSection" class="section">
            <div class="section-title">–ú–æ–∏ –∑–∞—è–≤–∫–∏</div>
            <div id="ordersContent"></div>
        </div>

        <div id="aboutSection" class="section">
            <div class="section-title">–û –Ω–∞—Å</div>
            <div id="aboutContent"></div>
            <a href="https://t.me/daud_bank" target="_blank" class="contact-btn"><span>‚úàÔ∏è</span><span>–°–≤—è–∑–∞—Ç—å—Å—è –≤ Telegram</span></a>
        </div>

        <div id="adminSection" class="section">
            <div class="section-title">‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            <div class="admin-tabs">
                <div class="admin-tab active" onclick="showAdminTab('rates')">üí∞ –ö—É—Ä—Å—ã</div>
                <div class="admin-tab" onclick="showAdminTab('cities')">üèôÔ∏è –ì–æ—Ä–æ–¥–∞</div>
                <div class="admin-tab" onclick="showAdminTab('texts')">üìù –¢–µ–∫—Å—Ç—ã</div>
                <div class="admin-tab" onclick="showAdminTab('orders')">üìã –ó–∞—è–≤–∫–∏</div>
            </div>
            <div id="adminRatesTab"><div id="adminRatesContent"></div></div>
            <div id="adminCitiesTab" style="display:none"><div id="adminCitiesContent"></div></div>
            <div id="adminTextsTab" style="display:none">
                <div class="admin-card"><div class="admin-card-title">üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</div><div class="input-group"><textarea id="adminWelcome" rows="6"></textarea></div><button class="submit-btn small" onclick="saveText('welcome')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å <span class="save-indicator" id="saveWelcome">‚úì</span></button></div>
                <div class="admin-card"><div class="admin-card-title">‚ÑπÔ∏è –û –Ω–∞—Å</div><div class="input-group"><textarea id="adminAbout" rows="6"></textarea></div><button class="submit-btn small" onclick="saveText('about')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å <span class="save-indicator" id="saveAbout">‚úì</span></button></div>
                <div class="admin-card"><div class="admin-card-title">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="input-group"><textarea id="adminContact" rows="4"></textarea></div><button class="submit-btn small" onclick="saveText('contact')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å <span class="save-indicator" id="saveContact">‚úì</span></button></div>
            </div>
            <div id="adminOrdersTab" style="display:none"><div id="adminOrdersContent"></div></div>
        </div>
    </div>

    <nav class="bottom-nav" id="bottomNav">
        <div class="nav-item active" data-section="exchange" onclick="showSection('exchange')"><span class="nav-icon">üí±</span><span class="nav-label">–û–±–º–µ–Ω</span></div>
        <div class="nav-item" data-section="main" onclick="showSection('main')"><span class="nav-icon">üìä</span><span class="nav-label">–ö—É—Ä—Å—ã</span></div>
        <div class="nav-item" data-section="orders" onclick="showSection('orders')"><span class="nav-icon">üìã</span><span class="nav-label">–ó–∞—è–≤–∫–∏</span></div>
        <div class="nav-item" data-section="about" onclick="showSection('about')"><span class="nav-icon">‚ÑπÔ∏è</span><span class="nav-label">–û –Ω–∞—Å</span></div>
        <div class="nav-item" data-section="admin" id="adminNavItem" style="display:none" onclick="showSection('admin')"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">–ê–¥–º–∏–Ω</span></div>
    </nav>

    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <div class="modal-icon">‚úÖ</div>
            <div class="modal-title">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</div>
            <div class="modal-text">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</div>
            <button class="modal-btn" onclick="closeModal()">–û—Ç–ª–∏—á–Ω–æ</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if(tg){tg.ready();tg.expand();tg.setHeaderColor('#1A365D');tg.setBackgroundColor('#1A365D');}
        const API_URL='http://138.226.246.114:8080';
        const userId=tg?.initDataUnsafe?.user?.id||0;
        let RATES={},SETTINGS={},isAdmin=false,currentCity=null,exchangeCity=null,exchangeType='buy';
        const ICONS={'SAR':'üá∏üá¶','TRY':'üáπüá∑','AED':'üá¶üá™','RUB':'üá∑üá∫','USDT/USD':'üíµ'};
        const getIcon=c=>ICONS[c]||'';

        async function api(endpoint,method='GET',data=null){
            const opts={method,headers:{'Content-Type':'application/json','X-Admin-ID':String(userId)}};
            if(data)opts.body=JSON.stringify(data);
            const res=await fetch(API_URL+endpoint,opts);
            return res.json();
        }

        async function loadData(){
            try{
                RATES=await api('/api/rates');
                SETTINGS=await api('/api/settings');
                const check=await api('/api/admin/check?id='+userId);
                isAdmin=check.is_admin;
                if(isAdmin)document.getElementById('adminNavItem').style.display='flex';
                renderCities();
                renderAbout();
            }catch(e){console.error(e);}
        }

        async function loadOrders(){
            if(!userId)return renderOrders([]);
            const orders=await api('/api/orders?user_id='+userId);
            renderOrders(orders);
        }

        async function loadAdminOrders(){
            const orders=await api('/api/admin/orders');
            renderAdminOrders(orders);
        }

        function renderCities(){
            const intl=Object.entries(RATES).filter(([,c])=>c.region==='international');
            const rus=Object.entries(RATES).filter(([,c])=>c.region==='russia');
            
            document.getElementById('mainCityGrid').innerHTML=intl.map(([id,c])=>`<div class="city-card" data-city="${id}" onclick="selectCity('${id}')"><div class="city-emoji">${c.emoji||'üìç'}</div><div class="city-name">${c.name}</div><div class="city-currency"><span>${c.flag}</span> ${c.currency}</div></div>`).join('')+`<div class="city-card" onclick="toggleRussia('main')"><div class="city-emoji">üá∑üá∫</div><div class="city-name">–†–æ—Å—Å–∏—è</div><div class="city-currency"><span>üá∑üá∫</span> RUB</div></div>`;
            
            document.getElementById('russiaCitiesGrid').innerHTML=rus.map(([id,c])=>`<div class="city-card city-card-small" data-city="${id}" onclick="selectCity('${id}')"><div class="city-emoji">${c.emoji||'üèîÔ∏è'}</div><div class="city-name">${c.name}</div><div class="city-currency">${c.currency}</div></div>`).join('');
            
            document.getElementById('exchangeCityGrid').innerHTML=intl.map(([id,c])=>`<div class="city-card" data-city="${id}" onclick="selectExchangeCity('${id}')"><div class="city-emoji">${c.emoji||'üìç'}</div><div class="city-name">${c.name}</div><div class="city-currency"><span>${c.flag}</span> ${c.currency}</div></div>`).join('')+`<div class="city-card" onclick="toggleRussia('exchange')"><div class="city-emoji">üá∑üá∫</div><div class="city-name">–†–æ—Å—Å–∏—è</div><div class="city-currency"><span>üá∑üá∫</span> RUB</div></div>`;
            
            document.getElementById('exchangeRussiaCitiesGrid').innerHTML=rus.map(([id,c])=>`<div class="city-card city-card-small" data-city="${id}" onclick="selectExchangeCity('${id}')"><div class="city-emoji">${c.emoji||'üèîÔ∏è'}</div><div class="city-name">${c.name}</div><div class="city-currency">${c.currency}</div></div>`).join('');
        }

        function renderAbout(){
            const about=SETTINGS.about||'';
            document.getElementById('aboutContent').innerHTML=`<div class="about-card"><div class="about-title">Fulus Exchange</div>${about.split('\n').filter(l=>l.trim()).map(l=>`<div class="about-item"><span class="about-text">${l}</span></div>`).join('')}</div>`;
        }

        function renderOrders(orders){
            const c=document.getElementById('ordersContent');
            if(!orders?.length){c.innerHTML=`<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</div><button class="submit-btn" onclick="showSection('exchange')">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button></div>`;return;}
            c.innerHTML=orders.map(o=>{const st=o.status||'pending';const stT=st==='pending'?'–í –æ–±—Ä–∞–±–æ—Ç–∫–µ':st==='completed'?'–ó–∞–≤–µ—Ä—à–µ–Ω–∞':'–û—Ç–º–µ–Ω–µ–Ω–∞';return`<div class="order-card"><div class="order-header"><span class="order-id">–ó–∞—è–≤–∫–∞ #${o.id}</span><span class="order-status ${st}">${stT}</span></div><div class="order-details"><div>üèôÔ∏è ${o.city}</div><div>üí± ${o.type}</div><div>üìÖ ${(o.created_at||'').slice(0,16)}</div></div><div class="order-amount">${o.amount} ‚Üí ${o.result}</div></div>`;}).join('');
        }

        function renderAdminOrders(orders){
            const c=document.getElementById('adminOrdersContent');
            if(!orders?.length){c.innerHTML='<div class="empty-state">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';return;}
            c.innerHTML=orders.map(o=>{const st=o.status||'pending';const stT=st==='pending'?'–í –æ–±—Ä–∞–±–æ—Ç–∫–µ':st==='completed'?'–ó–∞–≤–µ—Ä—à–µ–Ω–∞':'–û—Ç–º–µ–Ω–µ–Ω–∞';return`<div class="order-card"><div class="order-header"><span class="order-id">#${o.id}</span><span class="order-status ${st}">${stT}</span></div><div class="order-details"><div>üë§ ${o.first_name||o.username||'–ê–Ω–æ–Ω–∏–º'}</div><div>üì± ${o.contact||'-'}</div><div>üèôÔ∏è ${o.city}</div><div>üí± ${o.type} | ${o.pair}</div></div><div class="order-amount">${o.amount} ‚Üí ${o.result}</div>${st==='pending'?`<div class="order-actions"><button class="order-action-btn complete" onclick="updateOrderStatus('${o.id}','completed')">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å</button><button class="order-action-btn cancel" onclick="updateOrderStatus('${o.id}','cancelled')">‚úó –û—Ç–º–µ–Ω–∏—Ç—å</button></div>`:''}</div>`;}).join('');
        }

        function renderAdminRates(){
            document.getElementById('adminRatesContent').innerHTML=Object.entries(RATES).filter(([id])=>id!=='other').map(([id,city])=>`<div class="admin-card"><div class="admin-card-title">${city.emoji||'üìç'} ${city.name}</div>${city.pairs.map(p=>`<div class="rate-edit-row"><span>${p.quote}</span><input type="number" step="0.001" value="${p.buy_rate}" onchange="saveRate('${id}','${p.quote}','buy',this.value)" placeholder="Buy"><input type="number" step="0.001" value="${p.sell_rate}" onchange="saveRate('${id}','${p.quote}','sell',this.value)" placeholder="Sell"></div>`).join('')}</div>`).join('');
        }

        function renderAdminCities(){
            document.getElementById('adminCitiesContent').innerHTML=Object.entries(RATES).filter(([id])=>id!=='other').map(([id,city])=>`<div class="admin-card"><div class="admin-row"><input type="text" value="${city.emoji||''}" style="width:60px" onchange="saveCity('${id}','emoji',this.value)" placeholder="Emoji"><input type="text" value="${city.name}" onchange="saveCity('${id}','name',this.value)" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"></div></div>`).join('');
        }

        function renderAdminTexts(){
            document.getElementById('adminWelcome').value=SETTINGS.welcome||'';
            document.getElementById('adminAbout').value=SETTINGS.about||'';
            document.getElementById('adminContact').value=SETTINGS.contact||'';
        }

        function toggleRussia(section){
            document.getElementById(section==='main'?'russiaCities':'exchangeRussiaCities').classList.toggle('visible');
        }

        function selectCity(id){
            if(id==='other')return;
            currentCity=id;
            document.querySelectorAll('#mainSection .city-card').forEach(c=>c.classList.remove('active'));
            document.querySelector(`#mainSection [data-city="${id}"]`)?.classList.add('active');
            updateRates();
            document.getElementById('ratesSection').classList.add('visible');
        }

        function selectExchangeCity(id){
            exchangeCity=id;
            document.querySelectorAll('#exchangeSection .city-card').forEach(c=>c.classList.remove('active'));
            document.querySelector(`#exchangeSection [data-city="${id}"]`)?.classList.add('active');
            document.getElementById('exchangeFormContainer').style.display='block';
            const cityInput=document.getElementById('cityInput');
            if(id==='other'){cityInput.value='';cityInput.readOnly=false;cityInput.placeholder='–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥';cityInput.style.opacity='1';}
            else{cityInput.value=RATES[id]?.name||id;cityInput.readOnly=true;cityInput.style.opacity='0.7';}
            updatePairSelector();
            setTimeout(()=>document.getElementById('exchangeFormContainer').scrollIntoView({behavior:'smooth'}),100);
        }

        function updateRates(){
            if(!currentCity||!RATES[currentCity])return;
            const city=RATES[currentCity];
            document.getElementById('ratesContent').innerHTML=city.pairs.map(p=>`<div class="rate-card"><div class="rate-pair"><span class="currency-badge">${getIcon(city.currency)} ${city.currency}</span><span class="rate-arrow">‚áÑ</span><span class="currency-badge">${getIcon(p.quote)} ${p.quote}</span></div><div class="rate-values"><div class="rate-item"><div class="rate-label">–ö—É–ø–∏—Ç—å</div><div class="rate-value">${p.buy_rate}</div></div><div class="rate-item"><div class="rate-label">–ü—Ä–æ–¥–∞—Ç—å</div><div class="rate-value">${p.sell_rate}</div></div></div></div>`).join('');
        }

        function updatePairSelector(){
            if(!exchangeCity||!RATES[exchangeCity])return;
            const city=RATES[exchangeCity];
            document.getElementById('pairSelect').innerHTML=city.pairs.map((p,i)=>exchangeType==='buy'?`<option value="${i}">${getIcon(p.quote)} ${p.quote} ‚Üí ${getIcon(city.currency)} ${city.currency}</option>`:`<option value="${i}">${getIcon(city.currency)} ${city.currency} ‚Üí ${getIcon(p.quote)} ${p.quote}</option>`).join('');
            updateAmountLabel();
            updateCalculation();
        }

        function updateAmountLabel(){
            if(!exchangeCity||!RATES[exchangeCity])return;
            const city=RATES[exchangeCity];
            const pi=parseInt(document.getElementById('pairSelect').value)||0;
            const p=city.pairs[pi];
            const curr=exchangeType==='buy'?p.quote:city.currency;
            document.getElementById('amountLabel').innerHTML=`–°—É–º–º–∞ –≤ ${getIcon(curr)} ${curr}`;
        }

        function setExchangeType(type){
            exchangeType=type;
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            updatePairSelector();
        }

        function updateCalculation(){
            if(!exchangeCity||!RATES[exchangeCity]){document.getElementById('resultAmount').textContent='0.00';return;}
            const amount=parseFloat(document.getElementById('amountInput').value)||0;
            const city=RATES[exchangeCity];
            const pi=parseInt(document.getElementById('pairSelect').value)||0;
            const p=city.pairs[pi];
            let result,outCurr;
            if(exchangeType==='buy'){result=amount*p.buy_rate;outCurr=city.currency;}
            else{result=amount/p.sell_rate;outCurr=p.quote;}
            document.getElementById('resultAmount').textContent=`${result.toFixed(2)} ${getIcon(outCurr)} ${outCurr}`;
        }

        function showSection(section){
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`)?.classList.add('active');
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('visible'));
            document.getElementById(section+'Section').classList.add('visible');
            document.getElementById('russiaCities').classList.remove('visible');
            document.getElementById('exchangeRussiaCities').classList.remove('visible');
            if(section==='orders')loadOrders();
            if(section==='admin'&&isAdmin){renderAdminRates();renderAdminCities();renderAdminTexts();loadAdminOrders();}
            window.scrollTo({top:0,behavior:'smooth'});
        }

        function showAdminTab(tab){
            document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
            event.target.classList.add('active');
            ['Rates','Cities','Texts','Orders'].forEach(t=>document.getElementById('admin'+t+'Tab').style.display='none');
            document.getElementById('admin'+tab.charAt(0).toUpperCase()+tab.slice(1)+'Tab').style.display='block';
            if(tab==='orders')loadAdminOrders();
        }

        async function submitOrder(){
            const cityValue=document.getElementById('cityInput').value.trim();
            const name=document.getElementById('nameInput').value.trim();
            const amount=document.getElementById('amountInput').value;
            if(!cityValue){alert('–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥');return;}
            if(!name||!amount){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —Å—É–º–º—É');return;}
            const contact=document.getElementById('contactInput').value.trim();
            const city=RATES[exchangeCity];
            const pi=parseInt(document.getElementById('pairSelect').value)||0;
            const p=city.pairs[pi];
            let result,inCurr,outCurr,rateDisplay;
            if(exchangeType==='buy'){result=parseFloat(amount)*p.buy_rate;inCurr=p.quote;outCurr=city.currency;rateDisplay=`1 ${p.quote} = ${p.buy_rate} ${city.currency}`;}
            else{result=parseFloat(amount)/p.sell_rate;inCurr=city.currency;outCurr=p.quote;rateDisplay=`${p.sell_rate} ${city.currency} = 1 ${p.quote}`;}
            const orderData={user_id:userId,username:tg?.initDataUnsafe?.user?.username||'',name,contact:contact||'–ù–µ —É–∫–∞–∑–∞–Ω',city:cityValue,type:exchangeType==='buy'?'–ü–æ–∫—É–ø–∫–∞':'–ü—Ä–æ–¥–∞–∂–∞',pair:`${inCurr} ‚Üí ${outCurr}`,rate:rateDisplay,amount:`${amount} ${inCurr}`,result:`${result.toFixed(2)} ${outCurr}`};
            try{const res=await api('/api/order','POST',orderData);if(res.success){document.getElementById('successModal').classList.add('visible');document.getElementById('nameInput').value='';document.getElementById('contactInput').value='';document.getElementById('amountInput').value='';if(exchangeCity==='other')document.getElementById('cityInput').value='';updateCalculation();}}
            catch(e){if(tg?.sendData)tg.sendData(JSON.stringify(orderData));else document.getElementById('successModal').classList.add('visible');}
        }

        async function saveRate(cityId,quote,type,value){
            const data={city_id:cityId,quote};
            if(type==='buy')data.buy_rate=parseFloat(value);else data.sell_rate=parseFloat(value);
            await api('/api/admin/rate','POST',data);
            RATES=await api('/api/rates');
        }

        async function saveCity(cityId,field,value){
            const data={city_id:cityId};data[field]=value;
            await api('/api/admin/city','POST',data);
            RATES=await api('/api/rates');
            renderCities();
        }

        async function saveText(key){
            const value=document.getElementById('admin'+key.charAt(0).toUpperCase()+key.slice(1)).value;
            await api('/api/admin/setting','POST',{key,value});
            SETTINGS[key]=value;
            const ind=document.getElementById('save'+key.charAt(0).toUpperCase()+key.slice(1));
            ind.classList.add('visible');setTimeout(()=>ind.classList.remove('visible'),2000);
            if(key==='about')renderAbout();
        }

        async function updateOrderStatus(orderId,status){
            await api('/api/admin/order/status','POST',{order_id:orderId,status});
            loadAdminOrders();
        }

        function closeModal(){document.getElementById('successModal').classList.remove('visible');}

        document.querySelectorAll('input,textarea').forEach(el=>{
            el.addEventListener('focus',()=>{document.getElementById('bottomNav').style.display='none';});
            el.addEventListener('blur',()=>{setTimeout(()=>{document.getElementById('bottomNav').style.display='flex';},100);});
        });

        document.addEventListener('DOMContentLoaded',loadData);
    </script>
</body>
</html>
